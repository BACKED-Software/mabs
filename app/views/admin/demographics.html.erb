<%= content_for :title, "Demographic Statistics" %>
<div class="container mt-5">
  <h1>Demographic Statistics</h1>

  <div class="accordion" id="demographicsAccordion">
    <!-- Chart Selection -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingChartSelection">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChartSelection" aria-expanded="true" aria-controls="collapseChartSelection">
          Select Chart to Display
        </button>
      </h2>
      <div id="collapseChartSelection" class="accordion-collapse collapse show" aria-labelledby="headingChartSelection" data-bs-parent="#demographicsAccordion">
        <div class="accordion-body">
          <%= form_with url: admin_demographics_path, method: :get, local: true, id: "chart-selection-form", class: "row g-3" do |form| %>
            <div class="mb-3">
              <%= form.label :chart_type, 'Chart Type:' %>
              <%= form.select :chart_type, options_for_select(
                {
                  'Gender Distribution' => 'gender',
                  'Ethnicity Distribution' => 'ethnicity',
                  'Race Distribution' => 'race',
                  'US Citizen Distribution' => 'us_citizen',
                  'First Generation College Student Distribution' => 'first_generation',
                  'Classification Distribution' => 'classification'
                }, selected: params[:chart_type]
              ), include_blank: 'Select a chart...', class: "form-select" %>
            </div>
            <%= form.submit 'Show Chart', class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingChartDisplay">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChartDisplay" aria-expanded="false" aria-controls="collapseChartDisplay"  id="chart-display-button">
          Chart Display
        </button>
      </h2>

      <div id="collapseChartDisplay" class="accordion-collapse collapse" aria-labelledby="headingChartDisplay" data-bs-parent="#demographicsAccordion">
        <div class="accordion-body">
            <section class="statistics">
            <% case params[:chart_type] %>
            <% when 'gender' %>
              <h2>Gender Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @gender_distribution, xtitle: "Gender", ytitle: "Population", id: 'gender-distribution-chart', title: 'Gender Distribution' %>
              </div>
          
            <% when 'ethnicity' %>
              <h2>Ethnicity Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @ethnicity_distribution, xtitle: "Ethnicity", ytitle: "Population", id: 'ethnicity-distribution-chart', title: 'Hispanic or Latino Distribution' %>
              </div>
          
            <% when 'race' %>
              <h2>Race Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @race_distribution, xtitle: "Race", ytitle: "Population", id: 'race-distribution-chart', title: 'Race Distribution' %>
              </div>
          
            <% when 'us_citizen' %>
              <h2>US Citizen Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @us_citizen_distribution, xtitle: "Status", ytitle: "Population", id: 'us-citizen-distribution-chart', title: 'US Citizen Distribution' %>
              </div>
          
            <% when 'first_generation' %>
              <h2>First Generation College Student Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @first_generation_college_student_distribution, xtitle: "Status", ytitle: "Population", id: 'first-generation-college-student-distribution-chart', title: 'First Generation College Student Distribution' %>
              </div>
          
            <% when 'classification' %>
              <h2>Classification Distribution</h2>
              <div class="chart-container">
              <%= bar_chart @classification_distribution, xtitle: "Class Year", ytitle: "Population", id: 'classification-distribution-chart', title: 'Classification Distribution' %>
              </div>
          
            <% else %>
              <p>Please select a chart to display.</p>
            <% end %>
          </section>
        </div>
      </div>
    </div>
  </div>
<br>
  <h2> <%= link_to 'Download Demographic Data', export_demographics_path, method: :get , class: "btn btn-primary"%> </h2>
  <h2><%= link_to 'Back to Admin Dashboard', admin_tools_path , class: "btn btn-primary"%></h2>
  <h2><%= link_to 'Back to Dashboard', dashboard_index_path , class: "btn btn-primary"%></h2>
</div>

//Javascript for automatic button drop down 
<script>
document.addEventListener("turbo:load", function() {
  const chartSelectionForm = document.getElementById("chart-selection-form");
  const chartDisplayAccordionElement = document.getElementById("collapseChartDisplay");
  const chartDisplayAccordion = new bootstrap.Collapse(chartDisplayAccordionElement, {
    toggle: false 
  });

  if (chartSelectionForm) {
    chartSelectionForm.addEventListener("submit", function(event) {
      // Use setTimeout to allow form submission to process before toggling the drop down
      setTimeout(() => {
        // Check if a chart type is selected and show the chart display section
        const chartTypeSelect = document.querySelector("#chart-selection-form select[name='chart_type']");
        if (chartTypeSelect && chartTypeSelect.value !== "") {
          chartDisplayAccordion.show();
        }
      }, 500); // delay
    });
  }

  // Automatically expand the chart display section if a chart type is selected on page load
  const chartTypeSelect = document.querySelector("#chart-selection-form select[name='chart_type']");
  if (chartTypeSelect && chartTypeSelect.value !== "") {
    chartDisplayAccordion.show();
  }
});
</script>



