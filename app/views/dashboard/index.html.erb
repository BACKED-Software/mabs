<% content_for(:title, 'Dashboard') %>
<!-- Flash Messages -->
<% flash.each do |name, msg| %>
  <% if msg.is_a?(String) %>
    <div class="alert alert-<%= name == 'notice' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
      <%= msg %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
<% end %>

<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-md-5">
      <h1>Good Morning<% if user_signed_in? %>, <%= @user.full_name.split(" ").first %><% end %></h1>
      <p>Welcome to your dashboard</p>
      <div class="points-summary mt-5 p-4 bg-white rounded shadow text-center">
        <h4>Points Summary</h4>
        <div class="total-points mt-3">
          <h2>Total Points: <span class="points-value"> <%= @total_points %></span></h2>
        </div>
        <div class="actions mt-4">
          <%= require_sign_in do %>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pointsHistoryModal">View Point History</button>
            <a href="<%= leaderboard_index_path %>" class="btn btn-info">View Leaderboard</a>
          <% end %>

        </div>
        <hr/>
        <% if @two_most_recent_records.present? %>
          <div class="pointHistory mt-3 text-muted">
            <h6>Recently Awarded Points</h6>
            <ul class="list-unstyled mt-3">
              <% @two_most_recent_records.each do |record| %>
                <li class="point-history-item d-flex justify-content-between align-items-center">
                  <div class="point-history-details text-start">
                    <% if record.type == 'Attendance' %>
                      <p class="mb-0"><%= record.date.strftime('%m/%d') %> - Attendance to
                        <%= record.event ? record.event.eventName : 'Unknown Event' %></p>
                    <% else %>
                      <p class="mb-0"><%= record.date.strftime('%m/%d') %> - <%= record.awardDescription %></p>
                    <% end %>
                  </div>

                  <div class="point-history-points text-end text-primary">
                    <p class="mb-0"><%= record.points %></p>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>

      </div>
    </div>
      <!-- Announcement Column -->
    <div class="col-md-7">
      <div class="announcements bg-light rounded shadow">
        <div class="announcement-header ps-4 pt-4">
          <h4>Latest Announcements</h4>
        </div>
        <div class="announcement-list">
          <% @announcements.each do |announcement| %>
            <div class="announcement bg-info-subtle shadow-md rounded p-3 mb-3">
              <div class="d-flex align-items-center mb-2">
                <div class="avatar rounded-circle overflow-hidden me-3" style="width: 40px; height: 40px;">
                  <%= image_tag User.find_by(uid: announcement.googleUserID).avatar_url, alt: "User Avatar", class: "img-fluid" %>
                </div>
                <h5 class="mb-0 flex-grow-1"><%= announcement.subject %></h5>
              </div>
              <p class="text-muted mb-1"><%= announcement.dateOfAnnouncement.in_time_zone.strftime("%b %d, %Y, %I:%M %p %Z") %></p>

              <div id="announcement-content-<%= announcement.id %>" class="line-clamp">
                <%= announcement.body %>
              </div>
              <a href="#" class="text-muted read-more-link" style="font-size: 14px;" onclick="toggleContent('<%= announcement.id %>'); return false;">Read more</a>
            </div>
          <% end %>

        </div>


        <a href="<%= announcements_url %>" class="view-all-announcements btn btn-link">View All Announcements</a>
      </div>
    </div>
  </div>

  <!-- Events Section -->
  <div class="events mt-4 bg-white rounded p-4 shadow">
    <h4>Upcoming Events</h4>
    <ul class="list-unstyled mt-3">
      <% @events.sort_by(&:eventTime).each do |event| %>
        <li class="event mb-3 p-3 bg-light rounded">
          <div class="d-flex justify-content-between">
            <div>
              <div class="event-date text-primary"><strong><%= event.eventTime.strftime("%A, %B %-d") %></strong></div>
              <div class="event-details">
                <h5 class="event-title mb-1"><%= event.eventName %></h5>
                <p class="event-time text-muted"><%= event.eventTime.strftime("%H:%M") %></p>
                <p class="event-location text-muted mb-0"><%= event.eventLocation %></p>
              </div>
            </div>
            <% if user_signed_in? %>
              <% if Rsvp.exists?(user_uid: current_user.uid, event_id: event.id) %>
                <div class="rsvp-status text-success">You are attending</div>
              <% else %>
                <%= form_with url: rsvps_path, method: :post do |form| %>
                  <%= form.hidden_field :user_uid, value: current_user.uid %>
                  <%= form.hidden_field :event_id, value: event.id %>
                  <%= form.submit "RSVP" %>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </li>
      <% end %>
    </ul>
  </div>


  <div class="modal fade" id="pointsHistoryModal" tabindex="-1" aria-labelledby="pointsHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pointsHistoryModalLabel">Points History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= render 'points_history', user: @user %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</div>

<% content_for(:extra_js) do %>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
      .announcement-header {
          position: sticky;
          top: 0;
          z-index: 1000;
          width: 100%;

      }
      .announcement-list {
          padding: 20px;
          overflow-y: auto;
      }

      .view-all-announcements {
          position: sticky;
          bottom: 0;
          z-index: 1000;
          width: 100%;
          text-align: center;
          margin: 0px 0; /* Adjust as needed */
          background: none;
          text-decoration: underline;
          border: none;
          padding: 5px;
          cursor: pointer;
      }
  </style>

  <script>
      document.addEventListener("DOMContentLoaded", function() {
          var pointsPanel = document.querySelector('.points-summary');
          var announcementsPanel = document.querySelector('.announcements');
          var header = document.querySelector('.announcement-header');

          if (pointsPanel && announcementsPanel && header) {
              var pointsPanelBottom = pointsPanel.offsetTop + pointsPanel.offsetHeight;
              var headerHeight = header.offsetHeight;
              var maxHeight = pointsPanelBottom - announcementsPanel.offsetTop - headerHeight;

              var announcementList = document.querySelector('.announcement-list');
              if (announcementList) {
                  announcementList.style.maxHeight = maxHeight + 'px';
              }
          }
      });


      function toggleContent(announcementId) {
          const contentDiv = document.getElementById(`announcement-content-${announcementId}`);
          contentDiv.classList.toggle('line-clamp');
      }


  </script>

<% end %>